name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            name: git-forest-aarch64-apple-darwin
          - target: x86_64-apple-darwin
            os: macos-latest
            name: git-forest-x86_64-apple-darwin

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/git-forest dist/${{ matrix.name }}
          cd dist && tar czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ matrix.name }}.tar.gz

  deploy-worker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: cd worker && npm ci

      - name: Deploy worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: cd worker && npx wrangler deploy

  update-homebrew:
    needs: [build, deploy-worker]
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME#v}"
          REPO="dliv/workforest"
          TAP_REPO="dliv/homebrew-tools"

          AARCH64_URL="https://github.com/$REPO/releases/download/v$VERSION/git-forest-aarch64-apple-darwin.tar.gz"
          X86_64_URL="https://github.com/$REPO/releases/download/v$VERSION/git-forest-x86_64-apple-darwin.tar.gz"

          # Download release tarballs (fail fast on 404)
          curl -fSL -o aarch64.tar.gz "$AARCH64_URL"
          curl -fSL -o x86_64.tar.gz "$X86_64_URL"

          AARCH64_SHA=$(sha256sum aarch64.tar.gz | cut -d' ' -f1)
          X86_64_SHA=$(sha256sum x86_64.tar.gz | cut -d' ' -f1)

          echo "aarch64 SHA256: $AARCH64_SHA"
          echo "x86_64 SHA256: $X86_64_SHA"

          # Clone the tap repo, update formula, push
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/$TAP_REPO.git" tap
          cd tap

          sed -i "s/version \".*\"/version \"$VERSION\"/" Formula/git-forest.rb
          sed -i "/CPU.arm?/{n;n;s/sha256 \"[a-f0-9]\{64\}\"/sha256 \"$AARCH64_SHA\"/}" Formula/git-forest.rb
          sed -i "/CPU.intel?/{n;n;s/sha256 \"[a-f0-9]\{64\}\"/sha256 \"$X86_64_SHA\"/}" Formula/git-forest.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/git-forest.rb
          git diff --cached --quiet && echo "No changes to formula" && exit 0
          git commit -m "chore: bump git-forest to $VERSION"
          git push
