# Phase 2 — Cloudflare Infrastructure ✅

Standing up the backend for version check at `forest.dliv.gg`. **Complete as of v0.2.6.**

**Worker code lives in `worker/` subdirectory** of the main `dliv/workforest` repo. No separate repo needed — it's just a TypeScript/Wrangler project alongside the Rust CLI.

## Key Decisions

- **Shared types via ts-rs:** The `VersionResponse` struct in Rust derives `TS` (from the `ts-rs` crate) to auto-generate a TypeScript type. The worker imports this generated type — one source of truth for the wire format.
- **`just` for all tasks:** All Cloudflare operations (deploy, db migrate, secrets) are `just` recipes using `npx wrangler` (local devDependency, not globally installed). D1 and KV commands use `--remote` to target production.
- **Secrets management:** `wrangler.toml` is gitignored (contains resource IDs); `wrangler.toml.template` is committed with empty IDs. `.env` / `.env.template` pattern for API credentials. GitHub Secrets for CI.
- **Privacy-first logging:** Store city/country from Cloudflare's `request.cf` object — never store IP addresses.
- **Custom domain via config:** `workers_dev = false` + `custom_domain = true` in `wrangler.toml` — Cloudflare handles DNS and SSL automatically, no dashboard clicks needed.
- **Automated Homebrew updates:** Release workflow downloads tarballs, computes SHA256, and pushes updated formula to `dliv/homebrew-tools` via a fine-grained PAT.

## Shared Types with ts-rs

`ts-rs = "10"` as a dev dependency. Derive is `cfg_attr(test, ...)` — no runtime cost:

```rust
#[cfg_attr(test, derive(ts_rs::TS))]
#[cfg_attr(test, ts(export, export_to = "worker/src/generated/"))]
#[derive(Deserialize)]
struct VersionResponse {
    version: String,
}
```

Regenerate with `just generate-types` (sets `TS_RS_EXPORT_DIR=.` so output lands in `worker/src/generated/` instead of `bindings/`).

## Worker Layout

```
worker/
  src/
    index.ts                    ← Worker entry point
    generated/
      VersionResponse.ts        ← auto-generated by ts-rs
  .env                          ← gitignored (local secrets reference)
  .env.template                 ← committed (empty values)
  wrangler.toml                 ← gitignored (contains resource IDs)
  wrangler.toml.template        ← committed (empty IDs)
  package.json
  package-lock.json
  schema.sql
  tsconfig.json
```

## Just Recipes

```just
generate-types                  # Regenerate TS types from Rust
worker-deploy                   # Deploy worker to Cloudflare
worker-db-create                # Create D1 database
worker-db-migrate               # Apply schema to remote D1
worker-kv-create                # Create KV namespace
worker-kv-seed                  # Seed KV with current version
worker-logs                     # Tail worker logs
worker-query sql                # Run SQL against remote D1
```

## Release Workflow Jobs

```
build (matrix: aarch64, x86_64)
  └→ update-version (write to Cloudflare KV)
       └→ update-homebrew (push formula to dliv/homebrew-tools)
```

GitHub Secrets required:
- `CLOUDFLARE_API_TOKEN` — KV write permission
- `CLOUDFLARE_ACCOUNT_ID`
- `CF_KV_NAMESPACE_ID`
- `HOMEBREW_TAP_TOKEN` — fine-grained PAT with contents write on `dliv/homebrew-tools`

## Querying Usage Data

```bash
# Active users by location (last 7 days)
just worker-query "SELECT city, country, version, COUNT(*) as hits, MAX(timestamp) as last_seen FROM events WHERE timestamp > datetime('now', '-7 days') GROUP BY city, country, version ORDER BY hits DESC"

# Version adoption
just worker-query "SELECT version, COUNT(*) as checks FROM events WHERE timestamp > datetime('now', '-30 days') GROUP BY version"

# Geographic distribution
just worker-query "SELECT country, COUNT(*) as checks FROM events WHERE timestamp > datetime('now', '-30 days') GROUP BY country ORDER BY checks DESC"
```

## Future Improvements

- Add Linux builds to the release matrix
- Retention policy for D1 events (delete old rows periodically)
- Worker deploy via CI (currently manual `just worker-deploy`)
